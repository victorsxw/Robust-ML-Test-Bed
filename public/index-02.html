<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Robust ML Testbed</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .result-container {
            margin: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            min-height: 100px;
        }

        .checkbox-container {
            margin: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
        }

        .checkbox-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 5px;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            font-size: 14px;
        }

        .checkbox-item:hover {
            background-color: #f5f5f5;
        }

        .file-description {
            margin-right: 10px;
            color: #666;
            display: inline-block;
            vertical-align: middle;
        }

        .file-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #generatePDF, #nextStep {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            margin-right: 10px; /* 添加按钮之间的间距 */
        }

        #generatePDF:hover, #nextStep:hover {
            background-color: #0056b3;
        }

        .input-field {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .input-field.error {
            border-color: #ff4444;
        }

        .input-field.error::placeholder {
            color: #ff4444;
        }

        .loading-spinner {
            display: none;  /* 默认隐藏 */
            margin-left: 10px;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .processing-status {
            display: none;
            margin-left: 10px;
            color: #666;
            font-style: italic;
        }
        /* 添加反白样式 */
        .active {
        background-color: #eaeef1; /* 反白背景颜色 */
        color: rgb(35, 231, 9); /* 反白文字颜色 */
        border-radius: 8px; /* 圆角效果 */
    }

        .upload-status {
            margin-left: 10px;
            color: #666;
            font-style: italic;
        }

        .upload-success {
            margin-left: 10px;
            color: green;
            font-weight: bold;
        }

        .upload-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            gap: 10px; /* 元素间统一间距 */
            /* max-width: 500px; 限制容器宽度 */
            margin: 0 0 20px 0; /* Changed to left align */
        }

        .upload-section button {
            margin-left: 10px;
            max-width: 300px; /* 限制容器宽度 */
            
        }

        .param-container {
            margin-top: 10px;
            margin-left: 20px;
        }

        .param-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .param-input input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 150px;
        }

        .param-input label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Head Section -->
    <header>
        <h1><a href="index.html" style="color: inherit; text-decoration: none;">Welcome to Robust ML Testbed</a></h1>
        <nav>
            <ul>
                <li><a href="index-01.html">Vulnerability Assessment</a></li>
                <li><a href="index-02.html" class="active">Exploitation Assessment</a></li>
            </ul>
        </nav>
    </header>
    <!-- V1.0 Using the right panel to select the attack ID
    <div class="container">
        // right panel structure 
        <div class="right-panel">
            <h1>Attack Implementation</h1>
            <div class="form-container">
                <div class="form-group">
                    <label>Attack ID:</label>
                    <select id="Attack_ID">
                        <option value="" style="font-weight:bold;">Select Attack ID</option>
                        //Out-of-Distribution Attacks 
                        <optgroup label="Out-of-Distribution Attacks">
                            <option value="A_OOD_001">A_OOD_001</option>
                        </optgroup>
                        // Property Inference Attacks 
                        <optgroup label="Property Inference Attacks">
                            <option value="A_Property_inference_Attack_001">A_Property_inference_Attack_001</option>
                        </optgroup>
                        //Jailbreak Attacks 
                        <optgroup label="Jailbreak Attacks">
                            <option value="A_Jailbreak_001">A_Jailbreak_001</option>
                            <option value="A_Jailbreak_002">A_Jailbreak_002</option>
                        </optgroup>
                        //Indirect Prompt Injection 
                        <optgroup label="Indirect Prompt Injection">
                            <option value="A_Indirect_Prompt_injection_1">A_Indirect_Prompt_injection_1</option>
                            <option value="A_Indirect_Prompt_injection_2">A_Indirect_Prompt_injection_2</option>
                        </optgroup>
                        //GAI Poisoning 
                        <optgroup label="GAI Poisoning">
                            <option value="A_GAI_Poisoning_001">A_GAI_Poisoning_001</option>
                            <option value="A_GAI_Poisoning_002">A_GAI_Poisoning_002</option>
                        </optgroup>
                        //Goal Hijacking 
                        <optgroup label="Goal Hijacking">
                            <option value="A_Goal_Hijacking_001">A_Goal_Hijacking_001</option>
                            <option value="A_Goal_Hijacking_002">A_Goal_Hijacking_002</option>
                        </optgroup>
                        // Reconstruction Attacks 
                        <optgroup label="Reconstruction Attacks">
                            <option value="A_Reconstruction_001">A_Reconstruction_001</option>
                            <option value="A_Reconstruction_002">A_Reconstruction_002</option>
                            <option value="A_Reconstruction_003">A_Reconstruction_003</option>
                        </optgroup>
                        //Membership Inference  
                        <optgroup label="Membership Inference">
                            <option value="A_Membership_inference_001">A_Membership_inference_001</option>
                            <option value="A_Membership_inference_002">A_Membership_inference_002</option>
                            <option value="A_Membership_inference_003">A_Membership_inference_003</option>
                            <option value="A_Membership_inference_004">A_Membership_inference_004</option>
                            <option value="A_Membership_inference_005">A_Membership_inference_005</option>
                            <option value="A_Membership_inference_006">A_Membership_inference_006</option>
                        </optgroup>
                        //Backdoor Attacks  
                        <optgroup label="Backdoor Attacks">
                            <option value="A_Backdoor_001">A_Backdoor_001</option>
                            <option value="A_Backdoor_002">A_Backdoor_002</option>
                            <option value="A_Backdoor_003">A_Backdoor_003</option>
                            <option value="A_Backdoor_004">A_Backdoor_004</option>
                            <option value="A_Backdoor_005">A_Backdoor_005</option>
                            <option value="A_Backdoor_006">A_Backdoor_006</option>
                            <option value="A_Backdoor_007">A_Backdoor_007</option>
                            <option value="A_Backdoor_008">A_Backdoor_008</option>
                        </optgroup>
                        // Poisoning Attacks  
                        <optgroup label="Poisoning Attacks">
                            <option value="A_Poisoning_001">A_Poisoning_001</option>
                            <option value="A_Poisoning_002">A_Poisoning_002</option>
                            <option value="A_Poisoning_003">A_Poisoning_003</option>
                            <option value="A_Poisoning_004">A_Poisoning_004</option>
                            <option value="A_Poisoning_005">A_Poisoning_005</option>
                            <option value="A_Poisoning_006">A_Poisoning_006</option>
                            <option value="A_Poisoning_007">A_Poisoning_007</option>
                            <option value="A_Poisoning_008">A_Poisoning_008</option>
                            <option value="A_Poisoning_009">A_Poisoning_009</option>
                            <option value="A_Poisoning_010">A_Poisoning_010</option>
                            <option value="A_Poisoning_011">A_Poisoning_011</option>
                            <option value="A_Poisoning_012">A_Poisoning_012</option>
                        </optgroup>
                        //Evasion Attacks  
                        <optgroup label="Evasion Attacks">
                            <option value="A_Evasion_001">A_Evasion_001</option>
                            <option value="A_Evasion_002">A_Evasion_002</option>
                            <option value="A_Evasion_003">A_Evasion_003</option>
                            <option value="A_Evasion_004">A_Evasion_004</option>
                            <option value="A_Evasion_005">A_Evasion_005</option>
                            <option value="A_Evasion_006">A_Evasion_006</option>
                            <option value="A_Evasion_007">A_Evasion_007</option>
                            <option value="A_Evasion_008">A_Evasion_008</option>
                            <option value="A_Evasion_009">A_Evasion_009</option>
                            <option value="A_Evasion_010">A_Evasion_010</option>
                            <option value="A_Evasion_011">A_Evasion_011</option>
                            <option value="A_Evasion_012">A_Evasion_012</option>
                            <option value="A_Evasion_013">A_Evasion_013</option>
                            <option value="A_Evasion_014">A_Evasion_014</option>
                            <option value="A_Evasion_015">A_Evasion_015</option>
                            <option value="A_Evasion_016">A_Evasion_016</option>
                            <option value="A_Evasion_017">A_Evasion_017</option>
                            <option value="A_Evasion_018">A_Evasion_018</option>
                        </optgroup>                    
                    </select>
                </div>
                <button onclick="querySolutionRight()">Search</button>
                <div id="result-right">Results will appear here...</div>
            </div>
        </div>
    </div>   
    -->

    <!-- V2.0 Without selections, directly select the implementation ID after Input1 -->
    <div>
        <!-- 结果显示区域 ，如果不需要显示，则删除，同时删除document.getElementById('result-right').innerHTML
        <h1>Results of Input1</h1>
        <div id="result-right" class="result-container">Results will appear here...</div> 
        -->

        <!-- 添加复选框容器 -->
        <div class="checkbox-container">
            <h3>Select Implementations:</h3>
            <div id="implementation-checkboxes" class="checkbox-list"></div>
        </div>
    </div>

    <!-- Third panel structure -->
    <div class="third-panel">
        <!-- 原有的模型文件上传 -->
        <div class="upload-section">
            <label for="modelInput">Upload Model (optional):</label>
            <input type="file" id="modelInput" name="model" accept=".h5,.pt">
            <button type="button" onclick="uploadModel()">Upload Model</button>
        </div>

        <!-- 数据集1文件上传 -->
        <div class="upload-section">
            <label for="trainDatasetInput">Upload Training Dataset (optional):</label>
            <input type="file" id="trainDatasetInput" name="train_dataset" accept=".csv">
            <button type="button" onclick="uploadTrainDataset()">Upload Training Dataset</button>
        </div>

        <!-- 数据集2文件上传 -->
        <div class="upload-section">
            <label for="testDatasetInput">Upload Test Dataset (optional):</label>
            <input type="file" id="testDatasetInput" name="test_dataset" accept=".csv">
            <button type="button" onclick="uploadTestDataset()">Upload Test Dataset</button>
        </div>

        <!-- 安全评估按钮 -->
        <div class="form-group">
            <div style="display: flex; align-items: center;">
                <button onclick="sendToPython()">Exploitation Assessment</button>
                <div id="loadingSpinner" class="loading-spinner"></div>
                <span id="processingStatus" class="processing-status">Processing...</span>
            </div>
        </div>
        
        <!-- 安全评估结果显示 -->
        <div class="form-group">
            <!--<label>Assessment Result:</label>-->
            <textarea id="pythonResult" rows="10" cols="100" readonly></textarea>
        </div>

        <div class="form-group">
            <button id="generatePDF" class="btn" onclick="generateFinalReport()">
                Generate EA Report
            </button>
        </div>

    </div>
</div>


    <script>
        // Global variables
        let uploadedFileName = ''; // Store uploaded file path
        let globalImplementationIDArray = []; // Store Implementation IDs
       
/* V1.0 Using the right panel to select the attack ID
            // right panel search function
            function querySolutionRight() {
                const Attack_ID = document.getElementById('Attack_ID').value;// 获取攻击ID的值
                // 获取攻击ID的值
                if (!Attack_ID) {
                    alert('Please select the field');// 获取攻击ID的值
                    return;
                }
                document.getElementById('result-right').innerHTML = 'Sending request...';// 设置发送请求时的提示文本
                // 发送POST请求到后端API
                fetch('/api/query-solution-right', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Attack_ID
                    })
                })
                .then(response => response.json())
                .then(data => {// 显示格式化的JSON结果
                    // 将整个数据数组存储到全局变量
                    globalImplementationIDArray = data;

                    // 仅提取 Implementation_ID 并生成字符串
                    const implementations = data.map(item => item.Implementation_ID).join('<br>');
                    document.getElementById('result-right').innerHTML = 
                        `${implementations}`;
                })
                .catch(error => {// 显示错误信息
                    document.getElementById('result-right').innerHTML = 
                        `Error: ${error.message}`;
                });
            }
*/
   
/* V2.0 Without selections, directly select the implementation ID after Input1 */
           // right panel search function
           function querySolutionRight() {
                // 从 localStorage 获取 globalImplementations_1 数据
                const storedData = localStorage.getItem('globalImplementations_1');
                let Attack_ID;
                
                try {
                    const parsedData = JSON.parse(storedData);
                    // 从数组中获取第一个对象的ID属性
                    Attack_ID = parsedData[0]?.ID;
                } catch (error) {
                    console.error('Error parsing stored data:', error);
                }
                
                if (!Attack_ID) {
                    alert('No Attack ID found. Please select an attack from Input 1 first.');
                    return;
                }
                
                document.getElementById('result-right').innerHTML = 'Sending request...';
                
                fetch('/api/query-solution-right', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Attack_ID
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Received data:', data);
                    
                    if (data && data.data) {
                        globalImplementationIDArray = Array.isArray(data.data) ? data.data : [data.data];
                    } else if (Array.isArray(data)) {
                        globalImplementationIDArray = data;
                    } else if (typeof data === 'object') {
                        globalImplementationIDArray = [data];
                    } else {
                        throw new Error('Unexpected data format');
                    }

                    if (globalImplementationIDArray.length === 0) {
                        document.getElementById('result-right').innerHTML = 'No implementations found';
                        return;
                    }

                    const implementations = globalImplementationIDArray
                        .map(item => {
                            if (typeof item === 'string') {
                                return item;
                            } else if (item && item.Implementation_ID) {
                                return item.Implementation_ID;
                            } else {
                                console.warn('Invalid item format:', item);
                                return 'Invalid implementation data';
                            }
                        })
                        .filter(id => id)
                        .join('<br>');

                    document.getElementById('result-right').innerHTML = implementations || 'No valid implementations found';
                })
                .catch(error => {
                    console.error('Error details:', error);
                    document.getElementById('result-right').innerHTML = 
                        `Error: ${error.message}. Please check the console for details.`;
                });
            }

            // 修改通用文件上传处理函数
            function uploadFileToServer(file, fileType) {
                console.log('Starting upload for:', fileType, 'File:', file.name);
                
                // 从 localStorage 获取用户名
                const clientName = localStorage.getItem('globalClientName') || 'unknown_user';
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('type', fileType);
                
                fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'X-File-Type': fileType,
                        'X-Client-Name': clientName // 添加用户名到请求头
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 保存完整的文件名（包含时间戳）和路径
                        if (fileType === 'model') {
                            window.modelFileName = data.file.savedAs;
                            window.modelFilePath = data.file.path; // 保存完整路径
                            window.uploadedFileName = data.file.savedAs; // 保存完整文件名，包含时间戳
                            console.log('Set model file path:', window.modelFilePath);
                            console.log('Set uploaded file name:', window.uploadedFileName);
                        } else if (fileType === 'train_dataset') {
                            window.trainDatasetFileName = data.file.savedAs;
                            window.trainDatasetPath = data.file.path;
                        } else if (fileType === 'test_dataset') {
                            window.testDatasetFileName = data.file.savedAs;
                            window.testDatasetPath = data.file.path;
                        }
                        
                        // 显示成功消息
                        alert(`${fileType.charAt(0).toUpperCase() + fileType.slice(1)} file uploaded successfully`);
                        
                        // 添加上传成功标识
                        const fileInput = document.querySelector(`input[name="${fileType}"]`) || 
                                        document.getElementById(`${fileType}Input`);
                        if (fileInput) {
                            const successIndicator = document.createElement('span');
                            successIndicator.className = 'upload-success';
                            successIndicator.textContent = '✓ Uploaded';
                            
                            // 移除之前的成功标识（如果存在）
                            const existingIndicator = fileInput.parentNode.querySelector('.upload-success');
                            if (existingIndicator) {
                                existingIndicator.remove();
                            }
                            
                            fileInput.parentNode.appendChild(successIndicator);
                        }
                    } else {
                        throw new Error(data.message || 'Upload failed');
                    }
                })
                .catch(error => {
                    console.error('Upload error:', error);
                    alert(`Error uploading ${fileType} file: ${error.message}`);
                });
            }

            // 修改模型上传函数
            async function uploadModel() {
                const fileInput = document.getElementById('modelInput');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Please select a model file first');
                    return;
                }
                
                // 检查文件扩展名
                const fileExtension = file.name.split('.').pop().toLowerCase();
                if (fileExtension !== 'h5' && fileExtension !== 'pt') {
                    alert('Only .h5 and .pt file formats are allowed');
                    return;
                }
                
                // 检查是否有用户名
                const clientName = localStorage.getItem('globalClientName');
                if (!clientName) {
                    alert('Please enter your name in the previous page first');
                    return;
                }
                
                uploadFileToServer(file, 'model');
            }

            // 数据集1上传函数（可选）
            let dataset1FileName = '';
            function uploadDataset1() {
                const fileInput = document.getElementById('trainDatasetInput');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Please select a file for Dataset 1');
                    return;
                }
                
                // 检查文件扩展名
                const fileExtension = file.name.split('.').pop().toLowerCase();
                if (fileExtension !== 'csv') {
                    alert('Only .csv file format is allowed');
                    return;
                }
                dataset1FileName = file.name;
                uploadFileToServer(file, 'train_dataset');
            }

            // 数据集2上传函数（可选）
            let dataset2FileName = '';
            function uploadDataset2() {
                const fileInput = document.getElementById('testDatasetInput');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Please select a file for Dataset 2');
                    return;
                }
                
                // 检查文件扩展名
                const fileExtension = file.name.split('.').pop().toLowerCase();
                if (fileExtension !== 'csv') {
                    alert('Only .csv file format is allowed');
                    return;
                }
                dataset2FileName = file.name;
                uploadFileToServer(file, 'test_dataset');
            }

            // 调用python程序
            async function sendToPython() {
                const spinner = document.getElementById('loadingSpinner');
                const status = document.getElementById('processingStatus');
                const pythonResult = document.getElementById('pythonResult');
                
                spinner.style.display = 'inline-block';
                status.style.display = 'inline-block';
                status.textContent = 'Processing...';
                pythonResult.value = "Starting to process selected implementations...\n";

                const selectedImplementations = getSelectedImplementations();
                console.log('Selected Implementation IDs:', selectedImplementations);

                // 验证必要的参数
                const invalidRequests = selectedImplementations.filter(impl => {
                    if (['ART_PA_003', 'ART_PA_004', 'ART_PA_006', 'ART_PA_009'].includes(impl.implementation_ID) && 
                        (impl.poison_rate === undefined || impl.poison_rate < 0 || impl.poison_rate > 1)) {
                        return true;
                    }
                    if (impl.implementation_ID === 'ART_PA_007' && 
                        (!impl.num_samples || impl.num_samples < 1)) {
                        return true;
                    }
                    return false;
                });

                if (invalidRequests.length > 0) {
                    alert('Please enter valid parameters for all selected implementations');
                    hideLoadingElements();
                    return;
                }

                const processImplementation = async (implementation, retryCount = 0) => {
                    const maxRetries = 3;
                    const baseDelay = 2000;

                    try {
                        // 获取正确的implementation_ID
                        const implementation_ID = typeof implementation.implementation_ID === 'object' 
                            ? implementation.implementation_ID.implementation_ID 
                            : implementation.implementation_ID;

                        pythonResult.value += `\nProcessing Implementation ${implementation_ID}...\n`;
                        status.textContent = `Processing Implementation ${implementation_ID}...`;

                        // 构建基本请求数据
                        let requestData = {
                            implementation_ID: implementation_ID
                        };

                        // 添加特定实现所需的参数
                        if (implementation_ID === 'ART_PA_007' && implementation.num_samples) {
                            requestData.num_samples = parseInt(implementation.num_samples);
                        }
                        if (['ART_PA_003', 'ART_PA_004', 'ART_PA_006', 'ART_PA_009'].includes(implementation_ID) && 
                            implementation.poison_rate !== undefined) {
                            requestData.poison_rate = parseFloat(implementation.poison_rate);
                        }

                        // 如果需要文件名，添加到请求数据中
                        if (window.modelFileName) {
                            requestData.upload_file_name = window.modelFileName.replace(/\.(h5|pt)$/, '');
                        }

                        // 添加详细的请求数据日志
                        console.log('Debug - Full implementation object:', implementation);
                        console.log('Debug - Current implementation_ID:', implementation_ID);
                        console.log('Debug - Request data being sent:', requestData);
                        console.log('Debug - Model file name:', window.modelFileName);

                        console.log('Sending request with data:', [requestData]);

                        const response = await fetch('/api/process', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify([requestData])
                        });

                        // 添加响应调试信息
                        console.log('Debug - Response status:', response.status);
                        console.log('Debug - Response headers:', Object.fromEntries(response.headers.entries()));

                        if (!response.ok) {
                            const errorData = await response.json();
                            console.log('Debug - Error response data:', errorData);
                            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log('Debug - Success response data:', data);
                        console.log('Response for', implementation_ID, ':', data);
                        
                        // 提取状态信息
                        if (data.results && data.results[0]) {
                            const result = data.results[0];
                            if (result.error) {
                                // 检查是否是执行失败但文件已生成的情况
                                if (result.error.includes('error:execution_failed')) {
                                    pythonResult.value += `Note: Process completed for ${implementation_ID} with warnings. Results were generated.\n`;
                                } else {
                                    pythonResult.value += `Result for ${implementation_ID}: ${result.error}\n`;
                                }
                                // 不立即返回 false，继续检查文件生成状态
                            } else {
                                pythonResult.value += `Result for ${implementation_ID}: ${result.status || JSON.stringify(result)}\n`;
                            }
                        } else {
                            pythonResult.value += `Result for ${implementation_ID}: ${JSON.stringify(data)}\n`;
                        }

                        // 检查文件是否生成
                        try {
                            const checkResponse = await fetch(`/api/check-results?implementation_id=${implementation_ID}`);
                            const checkData = await checkResponse.json();
                            if (checkData.files_exist) {
                                pythonResult.value += `✓ Result files were generated for ${implementation_ID}\n`;
                                return true;
                            }
                        } catch (checkError) {
                            console.error('Error checking result files:', checkError);
                        }

                        return true;

                    } catch (error) {
                        console.error('Caught error in processImplementation:', error);
                        console.log('Original error message:', error.message);
                        // 修改错误处理，确保implementation_ID总是可用
                        const currentImplementationID = implementation_ID || implementation.implementation_ID || 'Unknown Implementation';
                        pythonResult.value += `Error processing ${currentImplementationID}: ${error.message}\n`;
                        return false;
                    }
                };

                try {
                    for (let i = 0; i < selectedImplementations.length; i++) {
                        const implementation = selectedImplementations[i];
                        await processImplementation(implementation);
                        // 在处理下一个实现之前添加延迟
                        if (i < selectedImplementations.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 3000));
                        }
                    }

                    pythonResult.value += "\nAll selected implementations have been processed.";
                    status.textContent = "Processing completed";

                } catch (error) {
                    console.error('Error:', error);
                    pythonResult.value += `\nError: ${error.message}`;
                    status.textContent = 'Error occurred during processing';
                } finally {
                    setTimeout(() => {
                        spinner.style.display = 'none';
                    }, 3000);
                }
            }

            // 辅助函数：隐藏加载元素
            function hideLoadingElements() {
                const spinner = document.getElementById('loadingSpinner');
                const status = document.getElementById('processingStatus');
                spinner.style.display = 'none';
                status.style.display = 'none';
            }

            // 页面加载时显示结果和生成复选框
            window.onload = function() {
                // 从localStorage中获取之前存储的搜索结果
                const searchResults = localStorage.getItem('searchResults');
                if (searchResults) {
                    try {
                        // 将JSON字符串解析为JavaScript对象
                        const data = JSON.parse(searchResults);
                        
                        // 处理不同格式的数据，确保globalImplementationIDArray是一个数组
                        if (data && data.data) {
                            globalImplementationIDArray = Array.isArray(data.data) ? data.data : [data.data];
                        } else if (Array.isArray(data)) {
                            globalImplementationIDArray = data;
                        } else if (typeof data === 'object') {
                            globalImplementationIDArray = [data];
                        }

                        // 如果没有实现数据，显示提示信息并返回
                        if (globalImplementationIDArray.length === 0) {
                            document.getElementById('result-right').innerHTML = 'No implementations found';
                            return;
                        }

                        // 将实现ID转换为HTML字符串，处理不同的数据格式
                        const implementations = globalImplementationIDArray
                            .map(item => {
                                if (typeof item === 'string') {
                                    return item;
                                } else if (item && item.Implementation_ID) {
                                    return item.Implementation_ID;
                                } else {
                                    console.warn('Invalid item format:', item);
                                    return 'Invalid implementation data';
                                }
                            })
                            .filter(id => id)  // 过滤掉无效的ID
                            .join('<br>');     // 用换行符连接所有ID

                        // 获取复选框容器元
                        const checkboxContainer = document.getElementById('implementation-checkboxes');
                        // 清空容器中的现有内容
                        checkboxContainer.innerHTML = '';

                        // 为每个实现ID创建复选框
                        globalImplementationIDArray.forEach((item, index) => {
                            // 获取实现ID，处理不同的数据格式
                            const implementation_id = typeof item === 'string' ? item : item.Implementation_ID;
                            if (!implementation_id) return;  // 如果没有有效的ID则跳过

                            // 创建复选框容器div
                            const checkboxDiv = createCheckboxItem(implementation_id, index);
                            checkboxContainer.appendChild(checkboxDiv);
                        });

                    } catch (error) {
                        // 如果解析过程出错，在控制台显示错误并更新UI提示
                        console.error('Error parsing search results:', error);
                        document.getElementById('result-right').innerHTML = 'Error displaying results';
                    }
                }
            };

            // 修改复选框生成逻辑
            function createCheckboxItem(implementation_id, index) {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'checkbox-item';

                // 创建复选框
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `impl-${index}`;
                checkbox.value = implementation_id;
                checkbox.addEventListener('change', function() {
                    updateParameterInput(implementation_id, this.checked);
                });

                // 创建标签
                const label = document.createElement('label');
                label.htmlFor = `impl-${index}`;
                label.textContent = implementation_id;

                // 创建参数输入框容器
                const paramContainer = document.createElement('div');
                paramContainer.id = `param-container-${index}`;
                paramContainer.className = 'param-container';
                paramContainer.style.display = 'none';

                // 添加到容器
                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                checkboxDiv.appendChild(paramContainer);

                return checkboxDiv;
            }

            // 更新参数输入框显示
            function updateParameterInput(implementation_id, isChecked) {
                const index = Array.from(document.querySelectorAll('.checkbox-item input[type="checkbox"]'))
                    .findIndex(cb => cb.value === implementation_id);
                const paramContainer = document.getElementById(`param-container-${index}`);
                
                if (isChecked) {
                    let inputHTML = '';
                    if (['ART_PA_003', 'ART_PA_004', 'ART_PA_006', 'ART_PA_009'].includes(implementation_id)) {
                        inputHTML = `
                            <div class="param-input">
                                <label>Poison Rate (float value):</label>
                                <input type="number" 
                                       step="0.1" 
                                       min="0" 
                                       max="1" 
                                       class="poison-rate-input" 
                                       data-implementation="${implementation_id}"
                                       placeholder="Enter poison rate (0-1)">
                            </div>
                        `;
                    } else if (implementation_id === 'ART_PA_007') {
                        inputHTML = `
                            <div class="param-input">
                                <label>Number of Samples (integer):</label>
                                <input type="number" 
                                       step="1" 
                                       min="1" 
                                       class="num-samples-input" 
                                       data-implementation="${implementation_id}"
                                       placeholder="Enter number of samples">
                            </div>
                        `;
                    }
                    paramContainer.innerHTML = inputHTML;
                    paramContainer.style.display = inputHTML ? 'block' : 'none';
                } else {
                    paramContainer.style.display = 'none';
                    paramContainer.innerHTML = '';
                }
            }

            // 获取选中的实现ID
            function getSelectedImplementations() {
                const selectedImplementations = [];
                const checkboxes = document.querySelectorAll('#implementation-checkboxes input[type="checkbox"]:checked');
                
                checkboxes.forEach(checkbox => {
                    const implementation_id = checkbox.value;
                    let requestObj = {
                        implementation_ID: implementation_id
                    };

                    // 添加参数
                    if (['ART_PA_003', 'ART_PA_004', 'ART_PA_006', 'ART_PA_009'].includes(implementation_id)) {
                        const poisonRateInput = document.querySelector(`.poison-rate-input[data-implementation="${implementation_id}"]`);
                        if (poisonRateInput && poisonRateInput.value) {
                            requestObj.poison_rate = parseFloat(poisonRateInput.value);
                        }
                    } else if (implementation_id === 'ART_PA_007') {
                        const numSamplesInput = document.querySelector(`.num-samples-input[data-implementation="${implementation_id}"]`);
                        if (numSamplesInput && numSamplesInput.value) {
                            requestObj.num_samples = parseInt(numSamplesInput.value);
                        }
                    }

                    // 如果需要模型文件名
                    if (implementation_id.startsWith("Tensorflow_privacy_MIM_") || 
                        implementation_id.startsWith("ART_evasion_") || 
                        implementation_id.startsWith("Privacy_meter_MIM_")) {
                        requestObj.upload_file_name = window.modelFileName;
                    }

                    selectedImplementations.push(requestObj);
                });

                return selectedImplementations;
            }
            
            // 生成最终报告
            async function generateFinalReport() {
                try {
                    await generateComprehensiveReport();
                } catch (error) {
                    console.error('Error generating report:', error);
                    alert('Failed to generate report: ' + error.message);
                }
            }

            // 修改上传函数
            async function uploadFile(fileInput, fieldName) {
                console.log('Starting file upload for:', fieldName);
                
                const formData = new FormData();
                const file = fileInput.files[0];
                
                if (!file) {
                    alert(`Please select a ${fieldName} file first`);
                    return false;
                }

                // 检查文件类型
                const isValidType = (fieldName === 'model' && (file.name.endsWith('.h5') || file.name.endsWith('.pt'))) ||
                                   ((fieldName === 'train_dataset' || fieldName === 'test_dataset') && 
                                    file.name.endsWith('.csv'));
                
                if (!isValidType) {
                    alert(`Invalid file type for ${fieldName}`);
                    return false;
                }

                console.log('Uploading file:', file.name);
                formData.append('file', file);

                try {
                    // 显示上传进度
                    const uploadStatus = document.createElement('div');
                    uploadStatus.className = 'upload-status';
                    uploadStatus.textContent = `Uploading ${fieldName}...`;
                    fileInput.parentNode.appendChild(uploadStatus);

                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        headers: {
                            'X-File-Type': fieldName // 使用自定义请求头传递文件类型
                        },
                        body: formData
                    });

                    console.log('Response received:', response.status);
                    const data = await response.json();
                    console.log('Response data:', data);

                    // 移除上传状态显示
                    uploadStatus.remove();

                    if (data.success) {
                        // 更新UI显示上传成功
                        const successIndicator = document.createElement('span');
                        successIndicator.className = 'upload-success';
                        successIndicator.textContent = '✓ Uploaded';
                        successIndicator.style.color = 'green';
                        successIndicator.style.marginLeft = '10px';
                        
                        // 移除之前的成功标识（如果存在）
                        const existingIndicator = fileInput.parentNode.querySelector('.upload-success');
                        if (existingIndicator) {
                            existingIndicator.remove();
                        }
                        
                        fileInput.parentNode.appendChild(successIndicator);

                        // 存储文件信息
                        window[`${fieldName}FileName`] = data.file.savedAs;
                        window[`${fieldName}Path`] = data.file.path;
                        
                        // 打印存储的信息以便调试
                        console.log(`Stored ${fieldName} information:`, {
                            fileName: window[`${fieldName}FileName`],
                            path: window[`${fieldName}Path`]
                        });
                        
                        return true;
                    } else {
                        throw new Error(data.message || 'Upload failed');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert(`Error uploading ${fieldName}: ${error.message}`);
                    return false;
                }
            }

            // 修改具体的上传函数
            async function uploadTrainDataset() {
                console.log('Upload training dataset triggered'); // 添加日志
                const fileInput = document.getElementById('trainDatasetInput');
                return await uploadFile(fileInput, 'train_dataset');
            }

            async function uploadTestDataset() {
                console.log('Upload test dataset triggered'); // 添加日志
                const fileInput = document.getElementById('testDatasetInput');
                return await uploadFile(fileInput, 'test_dataset');
            }

    </script>

    <!-- Foot Section -->
    <footer>
        <p>&copy; 2024 Robust ML Testbed. All rights reserved.</p>
        <p><a href="#privacy">Privacy Policy</a> | <a href="#terms">Terms of Service</a></p>
    </footer>

    <!-- 在 </body> 标签前添加 -->
    <script type="module" src="js/config/reportConfig.js"></script>
    <script type="module" src="js/utils/reportUtils.js"></script>
    <script type="module" src="js/reportGenerator.js"></script>
    <script type="module" src="js/main.js"></script>
</body>
</html> 