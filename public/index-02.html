<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Robust ML Test Bed</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .result-container {
            margin: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            min-height: 100px;
        }

        .checkbox-container {
            margin: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
        }

        .checkbox-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 5px;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            font-size: 14px;
        }

        .checkbox-item:hover {
            background-color: #f5f5f5;
        }

        .file-description {
            margin-right: 10px;
            color: #666;
            display: inline-block;
            vertical-align: middle;
        }

        .file-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #generatePDF, #nextStep {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            margin-right: 10px; /* 添加按钮之间的间距 */
        }

        #generatePDF:hover, #nextStep:hover {
            background-color: #0056b3;
        }

        .input-field {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .input-field.error {
            border-color: #ff4444;
        }

        .input-field.error::placeholder {
            color: #ff4444;
        }

        .loading-spinner {
            display: none;  /* 默认隐藏 */
            margin-left: 10px;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .processing-status {
            display: none;
            margin-left: 10px;
            color: #666;
            font-style: italic;
        }
        /* 添加反白样式 */
        .active {
        background-color: #eaeef1; /* 反白背景颜色 */
        color: rgb(35, 231, 9); /* 反白文字颜色 */
        border-radius: 8px; /* 圆角效果 */
    }

        .upload-status {
            margin-left: 10px;
            color: #666;
            font-style: italic;
        }

        .upload-success {
            margin-left: 10px;
            color: green;
            font-weight: bold;
        }

        .upload-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            gap: 10px; /* 元素间统一间距 */
            /* max-width: 500px; 限制容器宽度 */
            margin: 0 0 20px 0; /* Changed to left align */
        }

        .upload-section button {
            margin-left: 10px;
            max-width: 300px; /* 限制容器宽度 */
            
        }
    </style>
</head>
<body>
    <!-- Head Section -->
    <header>
        <h1><a href="index.html" style="color: inherit; text-decoration: none;">Welcome to Robust ML Test Bed</a></h1>
        <nav>
            <ul>
                <li><a href="index-01.html">Vulnerability Assessment</a></li>
                <li><a href="index-02.html" class="active">Exploitation Assessment</a></li>
            </ul>
        </nav>
    </header>
    <!-- V1.0 Using the right panel to select the attack ID
    <div class="container">
        // right panel structure 
        <div class="right-panel">
            <h1>Attack Implementation</h1>
            <div class="form-container">
                <div class="form-group">
                    <label>Attack ID:</label>
                    <select id="Attack_ID">
                        <option value="" style="font-weight:bold;">Select Attack ID</option>
                        //Out-of-Distribution Attacks 
                        <optgroup label="Out-of-Distribution Attacks">
                            <option value="A_OOD_001">A_OOD_001</option>
                        </optgroup>
                        // Property Inference Attacks 
                        <optgroup label="Property Inference Attacks">
                            <option value="A_Property_inference_Attack_001">A_Property_inference_Attack_001</option>
                        </optgroup>
                        //Jailbreak Attacks 
                        <optgroup label="Jailbreak Attacks">
                            <option value="A_Jailbreak_001">A_Jailbreak_001</option>
                            <option value="A_Jailbreak_002">A_Jailbreak_002</option>
                        </optgroup>
                        //Indirect Prompt Injection 
                        <optgroup label="Indirect Prompt Injection">
                            <option value="A_Indirect_Prompt_injection_1">A_Indirect_Prompt_injection_1</option>
                            <option value="A_Indirect_Prompt_injection_2">A_Indirect_Prompt_injection_2</option>
                        </optgroup>
                        //GAI Poisoning 
                        <optgroup label="GAI Poisoning">
                            <option value="A_GAI_Poisoning_001">A_GAI_Poisoning_001</option>
                            <option value="A_GAI_Poisoning_002">A_GAI_Poisoning_002</option>
                        </optgroup>
                        //Goal Hijacking 
                        <optgroup label="Goal Hijacking">
                            <option value="A_Goal_Hijacking_001">A_Goal_Hijacking_001</option>
                            <option value="A_Goal_Hijacking_002">A_Goal_Hijacking_002</option>
                        </optgroup>
                        // Reconstruction Attacks 
                        <optgroup label="Reconstruction Attacks">
                            <option value="A_Reconstruction_001">A_Reconstruction_001</option>
                            <option value="A_Reconstruction_002">A_Reconstruction_002</option>
                            <option value="A_Reconstruction_003">A_Reconstruction_003</option>
                        </optgroup>
                        //Membership Inference  
                        <optgroup label="Membership Inference">
                            <option value="A_Membership_inference_001">A_Membership_inference_001</option>
                            <option value="A_Membership_inference_002">A_Membership_inference_002</option>
                            <option value="A_Membership_inference_003">A_Membership_inference_003</option>
                            <option value="A_Membership_inference_004">A_Membership_inference_004</option>
                            <option value="A_Membership_inference_005">A_Membership_inference_005</option>
                            <option value="A_Membership_inference_006">A_Membership_inference_006</option>
                        </optgroup>
                        //Backdoor Attacks  
                        <optgroup label="Backdoor Attacks">
                            <option value="A_Backdoor_001">A_Backdoor_001</option>
                            <option value="A_Backdoor_002">A_Backdoor_002</option>
                            <option value="A_Backdoor_003">A_Backdoor_003</option>
                            <option value="A_Backdoor_004">A_Backdoor_004</option>
                            <option value="A_Backdoor_005">A_Backdoor_005</option>
                            <option value="A_Backdoor_006">A_Backdoor_006</option>
                            <option value="A_Backdoor_007">A_Backdoor_007</option>
                            <option value="A_Backdoor_008">A_Backdoor_008</option>
                        </optgroup>
                        // Poisoning Attacks  
                        <optgroup label="Poisoning Attacks">
                            <option value="A_Poisoning_001">A_Poisoning_001</option>
                            <option value="A_Poisoning_002">A_Poisoning_002</option>
                            <option value="A_Poisoning_003">A_Poisoning_003</option>
                            <option value="A_Poisoning_004">A_Poisoning_004</option>
                            <option value="A_Poisoning_005">A_Poisoning_005</option>
                            <option value="A_Poisoning_006">A_Poisoning_006</option>
                            <option value="A_Poisoning_007">A_Poisoning_007</option>
                            <option value="A_Poisoning_008">A_Poisoning_008</option>
                            <option value="A_Poisoning_009">A_Poisoning_009</option>
                            <option value="A_Poisoning_010">A_Poisoning_010</option>
                            <option value="A_Poisoning_011">A_Poisoning_011</option>
                            <option value="A_Poisoning_012">A_Poisoning_012</option>
                        </optgroup>
                        //Evasion Attacks  
                        <optgroup label="Evasion Attacks">
                            <option value="A_Evasion_001">A_Evasion_001</option>
                            <option value="A_Evasion_002">A_Evasion_002</option>
                            <option value="A_Evasion_003">A_Evasion_003</option>
                            <option value="A_Evasion_004">A_Evasion_004</option>
                            <option value="A_Evasion_005">A_Evasion_005</option>
                            <option value="A_Evasion_006">A_Evasion_006</option>
                            <option value="A_Evasion_007">A_Evasion_007</option>
                            <option value="A_Evasion_008">A_Evasion_008</option>
                            <option value="A_Evasion_009">A_Evasion_009</option>
                            <option value="A_Evasion_010">A_Evasion_010</option>
                            <option value="A_Evasion_011">A_Evasion_011</option>
                            <option value="A_Evasion_012">A_Evasion_012</option>
                            <option value="A_Evasion_013">A_Evasion_013</option>
                            <option value="A_Evasion_014">A_Evasion_014</option>
                            <option value="A_Evasion_015">A_Evasion_015</option>
                            <option value="A_Evasion_016">A_Evasion_016</option>
                            <option value="A_Evasion_017">A_Evasion_017</option>
                            <option value="A_Evasion_018">A_Evasion_018</option>
                        </optgroup>                    
                    </select>
                </div>
                <button onclick="querySolutionRight()">Search</button>
                <div id="result-right">Results will appear here...</div>
            </div>
        </div>
    </div>   
    -->

    <!-- V2.0 Without selections, directly select the implementation ID after Input1 -->
    <div>
        <!-- 结果显示区域 ，如果不需要显示，则删除，同时删除document.getElementById('result-right').innerHTML
        <h1>Results of Input1</h1>
        <div id="result-right" class="result-container">Results will appear here...</div> 
        -->

        <!-- 添加复选框容器 -->
        <div class="checkbox-container">
            <h3>Select Implementations:</h3>
            <div id="implementation-checkboxes" class="checkbox-list"></div>
        </div>
    </div>

    <!-- Third panel structure -->
    <div class="third-panel">
        <!-- 原有的模型文件上传 -->
        <div class="upload-section">
            <label for="modelInput">Upload Model (required):</label>
            <input type="file" id="modelInput" name="model" accept=".h5">
            <button type="button" onclick="uploadModel()">Upload Model</button>
        </div>

        <!-- 数据集1文件上传 -->
        <div class="upload-section">
            <label for="trainDatasetInput">Upload Training Dataset (optional):</label>
            <input type="file" id="trainDatasetInput" name="train_dataset" accept=".csv">
            <button type="button" onclick="uploadTrainDataset()">Upload Training Dataset</button>
        </div>

        <!-- 数据集2文件上传 -->
        <div class="upload-section">
            <label for="testDatasetInput">Upload Test Dataset (optional):</label>
            <input type="file" id="testDatasetInput" name="test_dataset" accept=".csv">
            <button type="button" onclick="uploadTestDataset()">Upload Test Dataset</button>
        </div>

        <!-- 安全评估按钮 -->
        <div class="form-group">
            <div style="display: flex; align-items: center;">
                <button onclick="sendToPython()">Exploitation Assessment</button>
                <div id="loadingSpinner" class="loading-spinner"></div>
                <span id="processingStatus" class="processing-status">Processing...</span>
            </div>
        </div>
        
        <!-- 安全评估结果显示 -->
        <div class="form-group">
            <!--<label>Assessment Result:</label>-->
            <textarea id="pythonResult" rows="10" cols="100" readonly></textarea>
        </div>

        <!-- 安全评估结果文件夹打开 -->
        <div class="form-group">
            <button onclick="openAnalysisResults()">Open Results Files</button>
        </div>
       
        <div class="form-group">
            <button id="generatePDF" class="btn" onclick="generateFinalReport()">
                Generate EA Report
            </button>
        </div>

    </div>
</div>


    <script>
        // Global variables
        let uploadedFileName = ''; // Store uploaded file path
        let globalImplementationIDArray = []; // Store Implementation IDs
       
/* V1.0 Using the right panel to select the attack ID
            // right panel search function
            function querySolutionRight() {
                const Attack_ID = document.getElementById('Attack_ID').value;// 获取攻击ID的值
                // 获取攻击ID的值
                if (!Attack_ID) {
                    alert('Please select the field');// 获取攻击ID的值
                    return;
                }
                document.getElementById('result-right').innerHTML = 'Sending request...';// 设置发送请求时的提示文本
                // 发送POST请求到后端API
                fetch('/api/query-solution-right', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Attack_ID
                    })
                })
                .then(response => response.json())
                .then(data => {// 显示格式化的JSON结果
                    // 将整个数据数组存储到全局变量
                    globalImplementationIDArray = data;

                    // 仅提取 Implementation_ID 并生成字符串
                    const implementations = data.map(item => item.Implementation_ID).join('<br>');
                    document.getElementById('result-right').innerHTML = 
                        `${implementations}`;
                })
                .catch(error => {// 显示错误信息
                    document.getElementById('result-right').innerHTML = 
                        `Error: ${error.message}`;
                });
            }
*/
   
/* V2.0 Without selections, directly select the implementation ID after Input1 */
           // right panel search function
           function querySolutionRight() {
                // 从 localStorage 获取 globalImplementations_1 数据
                const storedData = localStorage.getItem('globalImplementations_1');
                let Attack_ID;
                
                try {
                    const parsedData = JSON.parse(storedData);
                    // 从数组中获取第一个对象的ID属性
                    Attack_ID = parsedData[0]?.ID;
                } catch (error) {
                    console.error('Error parsing stored data:', error);
                }
                
                if (!Attack_ID) {
                    alert('No Attack ID found. Please select an attack from Input 1 first.');
                    return;
                }
                
                document.getElementById('result-right').innerHTML = 'Sending request...';
                
                fetch('/api/query-solution-right', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Attack_ID
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Received data:', data);
                    
                    if (data && data.data) {
                        globalImplementationIDArray = Array.isArray(data.data) ? data.data : [data.data];
                    } else if (Array.isArray(data)) {
                        globalImplementationIDArray = data;
                    } else if (typeof data === 'object') {
                        globalImplementationIDArray = [data];
                    } else {
                        throw new Error('Unexpected data format');
                    }

                    if (globalImplementationIDArray.length === 0) {
                        document.getElementById('result-right').innerHTML = 'No implementations found';
                        return;
                    }

                    const implementations = globalImplementationIDArray
                        .map(item => {
                            if (typeof item === 'string') {
                                return item;
                            } else if (item && item.Implementation_ID) {
                                return item.Implementation_ID;
                            } else {
                                console.warn('Invalid item format:', item);
                                return 'Invalid implementation data';
                            }
                        })
                        .filter(id => id)
                        .join('<br>');

                    document.getElementById('result-right').innerHTML = implementations || 'No valid implementations found';
                })
                .catch(error => {
                    console.error('Error details:', error);
                    document.getElementById('result-right').innerHTML = 
                        `Error: ${error.message}. Please check the console for details.`;
                });
            }

            // 修改通用文件上传处理函数
            function uploadFileToServer(file, fileType) {
                console.log('Starting upload for:', fileType, 'File:', file.name);
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('type', fileType);
                
                fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'X-File-Type': fileType
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 保存完整的文件名（包含时间戳）和路径
                        if (fileType === 'model') {
                            window.modelFileName = data.file.savedAs;
                            window.modelFilePath = data.file.path; // 保存完整路径
                            window.uploadedFileName = data.file.savedAs; // 保存完整文件名，包含时间戳
                            console.log('Set model file path:', window.modelFilePath);
                            console.log('Set uploaded file name:', window.uploadedFileName);
                        } else if (fileType === 'train_dataset') {
                            window.trainDatasetFileName = data.file.savedAs;
                            window.trainDatasetPath = data.file.path;
                        } else if (fileType === 'test_dataset') {
                            window.testDatasetFileName = data.file.savedAs;
                            window.testDatasetPath = data.file.path;
                        }
                        
                        // 显示成功消息
                        alert(`${fileType.charAt(0).toUpperCase() + fileType.slice(1)} file uploaded successfully`);
                        
                        // 添加上传成功标识
                        const fileInput = document.querySelector(`input[name="${fileType}"]`) || 
                                        document.getElementById(`${fileType}Input`);
                        if (fileInput) {
                            const successIndicator = document.createElement('span');
                            successIndicator.className = 'upload-success';
                            successIndicator.textContent = '✓ Uploaded';
                            
                            // 移除之前的成功标识（如果存在）
                            const existingIndicator = fileInput.parentNode.querySelector('.upload-success');
                            if (existingIndicator) {
                                existingIndicator.remove();
                            }
                            
                            fileInput.parentNode.appendChild(successIndicator);
                        }
                    } else {
                        throw new Error(data.message || 'Upload failed');
                    }
                })
                .catch(error => {
                    console.error('Upload error:', error);
                    alert(`Error uploading ${fileType} file: ${error.message}`);
                });
            }

            // 修改模型上传函数
            async function uploadModel() {
                const fileInput = document.getElementById('modelInput');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Please select a model file first');
                    return;
                }
                
                // 检查文件扩展名
                const fileExtension = file.name.split('.').pop().toLowerCase();
                if (fileExtension !== 'h5') {
                    alert('Only .h5 file format is allowed');
                    return;
                }
                
                // 上传文件
                uploadFileToServer(file, 'model');
            }

            // 数据集1上传函数（可选）
            let dataset1FileName = '';
            function uploadDataset1() {
                const fileInput = document.getElementById('trainDatasetInput');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Please select a file for Dataset 1');
                    return;
                }
                
                // 检查文件扩展名
                const fileExtension = file.name.split('.').pop().toLowerCase();
                if (fileExtension !== 'csv') {
                    alert('Only .csv file format is allowed');
                    return;
                }
                dataset1FileName = file.name;
                uploadFileToServer(file, 'train_dataset');
            }

            // 数据集2上传函数（可选）
            let dataset2FileName = '';
            function uploadDataset2() {
                const fileInput = document.getElementById('testDatasetInput');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Please select a file for Dataset 2');
                    return;
                }
                
                // 检查文件扩展名
                const fileExtension = file.name.split('.').pop().toLowerCase();
                if (fileExtension !== 'csv') {
                    alert('Only .csv file format is allowed');
                    return;
                }
                dataset2FileName = file.name;
                uploadFileToServer(file, 'test_dataset');
            }

            // 调用python程序
            async function sendToPython() {
                const spinner = document.getElementById('loadingSpinner');
                const status = document.getElementById('processingStatus');
                const pythonResult = document.getElementById('pythonResult');
                
                spinner.style.display = 'inline-block';
                status.style.display = 'inline-block';
                status.textContent = 'Processing...';
                pythonResult.value = "Starting to process selected implementations...\n";

                // 检查是否已上传模型文件
                if (!window.uploadedFileName) {
                    alert('Please upload a model file first');
                    hideLoadingElements();
                    return;
                }

                // 记录当前使用的文件名
                console.log('Using uploaded file name:', window.uploadedFileName);

                const selectedImplementations = getSelectedImplementations();
                console.log('Selected Implementation IDs:', selectedImplementations);

                if (!selectedImplementations || selectedImplementations.length === 0) {
                    alert('Please select at least one implementation');
                    hideLoadingElements();
                    return;
                }

                const processImplementation = async (implementation_ID, retryCount = 0) => {
                    const maxRetries = 3;
                    const baseDelay = 2000;

                    try {
                        pythonResult.value += `\nProcessing Implementation ${implementation_ID}...\n`;
                        status.textContent = `Processing Implementation ${implementation_ID}...`;

                        // 使用完整的文件名（包含时间戳）
                        const requestData = {
                            implementation_ID,
                            upload_file_name: window.modelFileName // 使用包含时间戳的完整文件名
                        };
                        console.log('Sending request with data:', requestData);

                        const response = await fetch('/api/process', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log('Response for', implementation_ID, ':', data);
                        pythonResult.value += `Result for ${implementation_ID}: ${JSON.stringify(data)}\n`;
                        return true;

                    } catch (error) {
                        console.error('Error processing:', implementation_ID, error);
                        
                        if (retryCount < maxRetries) {
                            const delay = baseDelay * Math.pow(2, retryCount);
                            pythonResult.value += `Retry attempt ${retryCount + 1} for ${implementation_ID} after ${delay/1000} seconds...\n`;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            return processImplementation(implementation_ID, retryCount + 1);
                        }
                        
                        pythonResult.value += `Error processing ${implementation_ID} after ${maxRetries} attempts: ${error.message}\n`;
                        return false;
                    }
                };

                try {
                    for (let i = 0; i < selectedImplementations.length; i++) {
                        const implementation_ID = selectedImplementations[i];
                        await processImplementation(implementation_ID);
                        // 在处理下一个实现之前添加延迟
                        if (i < selectedImplementations.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 3000));
                        }
                    }

                    pythonResult.value += "\nAll selected implementations have been processed.";
                    status.textContent = "Processing completed";

                } catch (error) {
                    console.error('Error:', error);
                    pythonResult.value += `\nError: ${error.message}`;
                    status.textContent = 'Error occurred during processing';
                } finally {
                    setTimeout(() => {
                        spinner.style.display = 'none';
                    }, 3000);
                }
            }

            // 辅助函数：隐藏加载元素
            function hideLoadingElements() {
                const spinner = document.getElementById('loadingSpinner');
                const status = document.getElementById('processingStatus');
                spinner.style.display = 'none';
                status.style.display = 'none';
            }

            // 直接打开执行结果的文件夹
            function openAnalysisResults() {
                fetch('/api/open-results-folder', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if(data.success) {
                        window.location.href = 'file:///D:/Lee/robust-ai/Attack_Results';                             
                        //alert('Results folder opened successfully');
                    } else {
                        console.error('Failed to open results folder:', data.message);//alert('Failed to open results folder');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error opening results folder');
                });
            }

            // 页面加载时显示结果和生成复选框
            window.onload = function() {
                // 从localStorage中获取之前存储的搜索结果
                const searchResults = localStorage.getItem('searchResults');
                if (searchResults) {
                    try {
                        // 将JSON字符串解析为JavaScript对象
                        const data = JSON.parse(searchResults);
                        
                        // 处理不同格式的数据，确保globalImplementationIDArray是一个数组
                        if (data && data.data) {
                            globalImplementationIDArray = Array.isArray(data.data) ? data.data : [data.data];
                        } else if (Array.isArray(data)) {
                            globalImplementationIDArray = data;
                        } else if (typeof data === 'object') {
                            globalImplementationIDArray = [data];
                        }

                        // 如果没有实现数据，显示提示信息并返回
                        if (globalImplementationIDArray.length === 0) {
                            document.getElementById('result-right').innerHTML = 'No implementations found';
                            return;
                        }

                        // 将实现ID转换为HTML字符串，处理不同的数据格式
                        const implementations = globalImplementationIDArray
                            .map(item => {
                                if (typeof item === 'string') {
                                    return item;
                                } else if (item && item.Implementation_ID) {
                                    return item.Implementation_ID;
                                } else {
                                    console.warn('Invalid item format:', item);
                                    return 'Invalid implementation data';
                                }
                            })
                            .filter(id => id)  // 过滤掉无效的ID
                            .join('<br>');     // 用换行符连接所有ID

                        // 在结果容器中显示实现ID列表，如果不需要显示，则删除，同时删除<div id="result-right" class="result-container">
                        //document.getElementById('result-right').innerHTML = implementations || 'No valid implementations found';

                        // 获取复选框容器元
                        const checkboxContainer = document.getElementById('implementation-checkboxes');
                        // 清空容器中的现有内容
                        checkboxContainer.innerHTML = '';

                        // 为每个实现ID创建复选框
                        globalImplementationIDArray.forEach((item, index) => {
                            // 获取实现ID，处理不同的数据格式
                            const implementation_id = typeof item === 'string' ? item : item.Implementation_ID;
                            if (!implementation_id) return;  // 如果没有有效的ID则跳过

                            // 创建复选框容器div
                            const checkboxDiv = document.createElement('div');
                            checkboxDiv.className = 'checkbox-item';

                            // 创建复选框input元素
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.id = `impl-${index}`;
                            checkbox.value = implementation_id;

                            // 创建复选框标签
                            const label = document.createElement('label');
                            label.htmlFor = `impl-${index}`;
                            label.textContent = implementation_id;

                            // 将复选框和标签添加到容器中
                            checkboxDiv.appendChild(checkbox);
                            checkboxDiv.appendChild(label);
                            checkboxContainer.appendChild(checkboxDiv);
                        });

                    } catch (error) {
                        // 如果解析过程出错，在控制台显示错误并更新UI提示
                        console.error('Error parsing search results:', error);
                        document.getElementById('result-right').innerHTML = 'Error displaying results';
                    }
                }
            };

            // 获取选中的实现ID
            function getSelectedImplementations() {
                const checkboxes = document.querySelectorAll('#implementation-checkboxes input[type="checkbox"]:checked');
                return Array.from(checkboxes).map(checkbox => checkbox.value);
            }
            
            // 生成最终报告
            function generateFinalReport() {
                console.log('Starting report generation...');

                // 获取选中的实现ID
                const selectedImplementations = getSelectedImplementations();
                if (!selectedImplementations || selectedImplementations.length === 0) {
                    alert('Please select at least one implementation before generating the report');
                    return;
                }

                // 对每个选中的实现ID验证文件是否存在
                async function checkFileExists(implementation_id, filetype) {
                    try {
                        const response = await fetch(`/Attack_Results/${implementation_id}/${filetype}`, { method: 'HEAD' });
                        return response.ok;
                    } catch (error) {
                        console.error(`File check error for ${implementation_id}.${filetype}:`, error);
                        return false;
                    }
                }

                // 为每个选中的实现ID创建分析结果部分的HTML
                function createAnalysisSection(implementation_id) {
                    return `
                        <div class="report-section">
                            <h2>Analysis Results of Assessment : ${implementation_id}</h2>
                            <!-- 显示图片 -->
                            <h3>Results Digram</h3>
                            <div id="imageContainer_${implementation_id}">Loading image...</div>
                            
                            <!-- 显示 JSON 数据 -->
                            <h3>Results Summary</h3>
                            <h3><div id="jsonContent_${implementation_id}" class="json-content">                            
                            </div></h3>
                        </div>
                    `;
                }

                // 创建报告内容
                const finalReportContent = {
                    title: 'Exploitation Assessment Report',
                    date: new Date().toLocaleString(),
                    modelFile: modelFileName || 'No model file uploaded',
                    trainingData: dataset1FileName || 'No training dataset uploaded',
                    testData: dataset2FileName || 'No test dataset uploaded',
                    implementations: selectedImplementations,
                    assessmentResults: document.getElementById('pythonResult').value
                };

                // 创建报告模板
                const template = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${finalReportContent.title}</title>
                        <style>
                            body {
                                font-family: Arial, sans-serif;
                                padding: 20px;
                                line-height: 1.6;
                            }
                            h1 {
                                color: #333;
                                border-bottom: 2px solid #007bff;
                                padding-bottom: 10px;
                            }
                            .report-section {
                                margin: 20px 0;
                            }
                            .report-item {
                                margin: 10px 0;
                            }
                            .label {
                                font-weight: bold;
                                color: #007bff;
                            }
                            pre {
                                background-color: #f5f5f5;
                                padding: 10px;
                                border-radius: 4px;
                                overflow-x: auto;
                                white-space: pre-wrap;
                                word-wrap: break-word;
                            }
                            .result-image {
                                max-width: 100%;
                                height: auto;
                                margin: 20px 0;
                            }
                            .json-content {
                                background-color: #f8f9fa;
                                border: 1px solid #dee2e6;
                                border-radius: 4px;
                                padding: 15px;
                                margin: 10px 0;
                            }
                        </style>
                    </head>
                    <body>
                        <h1>${finalReportContent.title}</h1>
                        
                        <div class="report-section">
                            <p><span class="label">Generated on:</span> ${finalReportContent.date}</p>
                        </div>

                        <div class="report-section">
                            <h2>Uploaded Files</h2>
                            <p><span class="label">Model File:</span> ${finalReportContent.modelFile}</p>
                            <p><span class="label">Training Dataset:</span> ${finalReportContent.trainingData}</p>
                            <p><span class="label">Test Dataset:</span> ${finalReportContent.testData}</p>
                        </div>

                        <div class="report-section">
                            <h2>Selected Implementations</h2>
                            <ul>
                                ${finalReportContent.implementations.map((impl, index) => 
                                    `<li><span class="label">Implementation ${index + 1}:</span> ${impl}</li>`
                                ).join('')}
                            </ul>
                        </div>

                        <div class="report-section">
                            <h2>Assessment Records</h2>
                            <h3><pre>${finalReportContent.assessmentResults}</pre></h3>
                        </div>

                        <!-- 为每个实现ID创建分析结果部分 -->
                        ${selectedImplementations.map(createAnalysisSection).join('')}
                    </body>
                    </html>
                `;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(template);

                // 为每个选中的实现ID加载图片和JSON数据
                selectedImplementations.forEach(implementation_id => {
                    // 加载图片
                    const img = new Image();
                    img.onload = function() {
                        const imageContainer = printWindow.document.getElementById(`imageContainer_${implementation_id}`);
                        if (imageContainer) {
                            imageContainer.innerHTML = '';
                            imageContainer.appendChild(img.cloneNode());
                        }
                    };
                    img.onerror = function() {
                        const imageContainer = printWindow.document.getElementById(`imageContainer_${implementation_id}`);
                        if (imageContainer) {
                            imageContainer.innerHTML = `Error loading image for implementation: ${implementation_id}`;
                        }
                    };
                    // 使用选中的实现ID构建图片URL
                    img.src = `/Attack_Results/${implementation_id}/png`;
                    img.className = 'result-image';

                    // 加载JSON数据
                    fetch(`/Attack_Results/${implementation_id}/json`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Failed to load data for implementation: ${implementation_id}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            const jsonContent = printWindow.document.getElementById(`jsonContent_${implementation_id}`);
                            if (jsonContent) {
                                // 显示摘要信息
                                const formattedContent = data.messages.map(message => {
                                    return `<div class="summary-entry">${message}</div>`;
                                }).join('\n');

                                // 添加样式
                                jsonContent.innerHTML = `
                                    <style>
                                        .summary-entry {
                                            margin: 10px 0;
                                            padding: 10px;
                                            background-color: #f8f9fa;
                                            border-radius: 4px;
                                            font-family: monospace;
                                            white-space: pre-wrap;
                                        }
                                    </style>
                                    ${formattedContent}
                                `;
                            }
                        })
                        .catch(error => {
                            console.error(`Error loading JSON file for ${implementation_id}:`, error);
                            const jsonContent = printWindow.document.getElementById(`jsonContent_${implementation_id}`);
                            if (jsonContent) {
                                jsonContent.innerHTML = `Error loading summary for implementation ${implementation_id}: ${error.message}`;
                            }
                        });
                });

                // 等待所有内容加载完成后打印
                printWindow.document.close();
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                    }, 2000);
                };
            }
            // 修改上传函数
            async function uploadFile(fileInput, fieldName) {
                console.log('Starting file upload for:', fieldName);
                
                const formData = new FormData();
                const file = fileInput.files[0];
                
                if (!file) {
                    alert(`Please select a ${fieldName} file first`);
                    return false;
                }

                // 检查文件类型
                const isValidType = (fieldName === 'model' && file.name.endsWith('.h5')) ||
                                   ((fieldName === 'train_dataset' || fieldName === 'test_dataset') && 
                                    file.name.endsWith('.csv'));
                
                if (!isValidType) {
                    alert(`Invalid file type for ${fieldName}`);
                    return false;
                }

                console.log('Uploading file:', file.name);
                formData.append('file', file);

                try {
                    // 显示上传进度
                    const uploadStatus = document.createElement('div');
                    uploadStatus.className = 'upload-status';
                    uploadStatus.textContent = `Uploading ${fieldName}...`;
                    fileInput.parentNode.appendChild(uploadStatus);

                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        headers: {
                            'X-File-Type': fieldName // 使用自定义请求头传递文件类型
                        },
                        body: formData
                    });

                    console.log('Response received:', response.status);
                    const data = await response.json();
                    console.log('Response data:', data);

                    // 移除上传状态显示
                    uploadStatus.remove();

                    if (data.success) {
                        // 更新UI显示上传成功
                        const successIndicator = document.createElement('span');
                        successIndicator.className = 'upload-success';
                        successIndicator.textContent = '✓ Uploaded';
                        successIndicator.style.color = 'green';
                        successIndicator.style.marginLeft = '10px';
                        
                        // 移除之前的成功标识（如果存在）
                        const existingIndicator = fileInput.parentNode.querySelector('.upload-success');
                        if (existingIndicator) {
                            existingIndicator.remove();
                        }
                        
                        fileInput.parentNode.appendChild(successIndicator);

                        // 存储文件信息
                        window[`${fieldName}FileName`] = data.file.savedAs;
                        window[`${fieldName}Path`] = data.file.path;
                        
                        // 打印存储的信息以便调试
                        console.log(`Stored ${fieldName} information:`, {
                            fileName: window[`${fieldName}FileName`],
                            path: window[`${fieldName}Path`]
                        });
                        
                        return true;
                    } else {
                        throw new Error(data.message || 'Upload failed');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert(`Error uploading ${fieldName}: ${error.message}`);
                    return false;
                }
            }

            // 修改具体的上传函数
            async function uploadTrainDataset() {
                console.log('Upload training dataset triggered'); // 添加日志
                const fileInput = document.getElementById('trainDatasetInput');
                return await uploadFile(fileInput, 'train_dataset');
            }

            async function uploadTestDataset() {
                console.log('Upload test dataset triggered'); // 添加日志
                const fileInput = document.getElementById('testDatasetInput');
                return await uploadFile(fileInput, 'test_dataset');
            }

    </script>

    <!-- Foot Section -->
    <footer>
        <p>&copy; 2024 Robust ML Test Bed. All rights reserved.</p>
        <p><a href="#privacy">Privacy Policy</a> | <a href="#terms">Terms of Service</a></p>
    </footer>
</body>
</html> 