<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Robust ML Test Bed</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .result-container {
            margin: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            min-height: 100px;
        }

        .checkbox-container {
            margin: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
        }

        .checkbox-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 5px;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            font-size: 14px;
        }

        .checkbox-item:hover {
            background-color: #f5f5f5;
        }

        .file-description {
            margin-right: 10px;
            color: #666;
            display: inline-block;
            vertical-align: middle;
        }

        .file-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <!-- Head Section -->
    <header>
        <h1><a href="index.html" style="color: inherit; text-decoration: none;">Welcome to Robust ML Test Bed</a></h1>
        <nav>
            <ul>
                <li><a href="index-01.html">INPUT1</a></li>
                <li><a href="index-02.html">INPUT2</a></li>
            </ul>
        </nav>
    </header>
    <!-- V1.0 Using the right panel to select the attack ID
    <div class="container">
        // right panel structure 
        <div class="right-panel">
            <h1>Attack Implementation</h1>
            <div class="form-container">
                <div class="form-group">
                    <label>Attack ID:</label>
                    <select id="Attack_ID">
                        <option value="" style="font-weight:bold;">Select Attack ID</option>
                        //Out-of-Distribution Attacks 
                        <optgroup label="Out-of-Distribution Attacks">
                            <option value="A_OOD_001">A_OOD_001</option>
                        </optgroup>
                        // Property Inference Attacks 
                        <optgroup label="Property Inference Attacks">
                            <option value="A_Property_inference_Attack_001">A_Property_inference_Attack_001</option>
                        </optgroup>
                        //Jailbreak Attacks 
                        <optgroup label="Jailbreak Attacks">
                            <option value="A_Jailbreak_001">A_Jailbreak_001</option>
                            <option value="A_Jailbreak_002">A_Jailbreak_002</option>
                        </optgroup>
                        //Indirect Prompt Injection 
                        <optgroup label="Indirect Prompt Injection">
                            <option value="A_Indirect_Prompt_injection_1">A_Indirect_Prompt_injection_1</option>
                            <option value="A_Indirect_Prompt_injection_2">A_Indirect_Prompt_injection_2</option>
                        </optgroup>
                        //GAI Poisoning 
                        <optgroup label="GAI Poisoning">
                            <option value="A_GAI_Poisoning_001">A_GAI_Poisoning_001</option>
                            <option value="A_GAI_Poisoning_002">A_GAI_Poisoning_002</option>
                        </optgroup>
                        //Goal Hijacking 
                        <optgroup label="Goal Hijacking">
                            <option value="A_Goal_Hijacking_001">A_Goal_Hijacking_001</option>
                            <option value="A_Goal_Hijacking_002">A_Goal_Hijacking_002</option>
                        </optgroup>
                        // Reconstruction Attacks 
                        <optgroup label="Reconstruction Attacks">
                            <option value="A_Reconstruction_001">A_Reconstruction_001</option>
                            <option value="A_Reconstruction_002">A_Reconstruction_002</option>
                            <option value="A_Reconstruction_003">A_Reconstruction_003</option>
                        </optgroup>
                        //Membership Inference  
                        <optgroup label="Membership Inference">
                            <option value="A_Membership_inference_001">A_Membership_inference_001</option>
                            <option value="A_Membership_inference_002">A_Membership_inference_002</option>
                            <option value="A_Membership_inference_003">A_Membership_inference_003</option>
                            <option value="A_Membership_inference_004">A_Membership_inference_004</option>
                            <option value="A_Membership_inference_005">A_Membership_inference_005</option>
                            <option value="A_Membership_inference_006">A_Membership_inference_006</option>
                        </optgroup>
                        //Backdoor Attacks  
                        <optgroup label="Backdoor Attacks">
                            <option value="A_Backdoor_001">A_Backdoor_001</option>
                            <option value="A_Backdoor_002">A_Backdoor_002</option>
                            <option value="A_Backdoor_003">A_Backdoor_003</option>
                            <option value="A_Backdoor_004">A_Backdoor_004</option>
                            <option value="A_Backdoor_005">A_Backdoor_005</option>
                            <option value="A_Backdoor_006">A_Backdoor_006</option>
                            <option value="A_Backdoor_007">A_Backdoor_007</option>
                            <option value="A_Backdoor_008">A_Backdoor_008</option>
                        </optgroup>
                        // Poisoning Attacks  
                        <optgroup label="Poisoning Attacks">
                            <option value="A_Poisoning_001">A_Poisoning_001</option>
                            <option value="A_Poisoning_002">A_Poisoning_002</option>
                            <option value="A_Poisoning_003">A_Poisoning_003</option>
                            <option value="A_Poisoning_004">A_Poisoning_004</option>
                            <option value="A_Poisoning_005">A_Poisoning_005</option>
                            <option value="A_Poisoning_006">A_Poisoning_006</option>
                            <option value="A_Poisoning_007">A_Poisoning_007</option>
                            <option value="A_Poisoning_008">A_Poisoning_008</option>
                            <option value="A_Poisoning_009">A_Poisoning_009</option>
                            <option value="A_Poisoning_010">A_Poisoning_010</option>
                            <option value="A_Poisoning_011">A_Poisoning_011</option>
                            <option value="A_Poisoning_012">A_Poisoning_012</option>
                        </optgroup>
                        //Evasion Attacks  
                        <optgroup label="Evasion Attacks">
                            <option value="A_Evasion_001">A_Evasion_001</option>
                            <option value="A_Evasion_002">A_Evasion_002</option>
                            <option value="A_Evasion_003">A_Evasion_003</option>
                            <option value="A_Evasion_004">A_Evasion_004</option>
                            <option value="A_Evasion_005">A_Evasion_005</option>
                            <option value="A_Evasion_006">A_Evasion_006</option>
                            <option value="A_Evasion_007">A_Evasion_007</option>
                            <option value="A_Evasion_008">A_Evasion_008</option>
                            <option value="A_Evasion_009">A_Evasion_009</option>
                            <option value="A_Evasion_010">A_Evasion_010</option>
                            <option value="A_Evasion_011">A_Evasion_011</option>
                            <option value="A_Evasion_012">A_Evasion_012</option>
                            <option value="A_Evasion_013">A_Evasion_013</option>
                            <option value="A_Evasion_014">A_Evasion_014</option>
                            <option value="A_Evasion_015">A_Evasion_015</option>
                            <option value="A_Evasion_016">A_Evasion_016</option>
                            <option value="A_Evasion_017">A_Evasion_017</option>
                            <option value="A_Evasion_018">A_Evasion_018</option>
                        </optgroup>                    
                    </select>
                </div>
                <button onclick="querySolutionRight()">Search</button>
                <div id="result-right">Results will appear here...</div>
            </div>
        </div>
    </div>   
    -->

    <!-- V2.0 Without selections, directly select the implementation ID after Input1 -->
    <div>
        <!-- 结果显示区域 -->
        <h1>Results of Input1</h1>
        <div id="result-right" class="result-container">Results will appear here...</div> 
        
        <!-- 添加复选框容器 -->
        <div class="checkbox-container">
            <h3>Select Implementations:</h3>
            <div id="implementation-checkboxes" class="checkbox-list"></div>
        </div>
    </div>

    <!-- Third panel structure -->
    <div class="third-panel">
            <div class="form-container">
            <div class="form-group">
                <label>Upload File:</label>
                <div class="file-inputs">
                    <span class="file-description">Upload Model Profile:</span>  <!-- input model profile -->                    
                    <input type="file" id="fileInput" class="file-input" accept=".h5">
                    <button class="upload-btn" onclick="uploadFile()">Upload</button>
                </div>
                <div class="file-inputs">
                    <span class="file-description">Upload Training Dataset:</span>  <!-- input training dataset -->                    
                    <input type="file" id="fileInput" class="file-input" accept=".h5">
                    <button class="upload-btn" onclick="uploadFile()">Upload</button>
                </div>
                <div class="file-inputs">
                    <span class="file-description">Upload Testing Dataset:</span>  <!-- input testing dataset -->                    
                    <input type="file" id="fileInput" class="file-input" accept=".h5">
                    <button class="upload-btn" onclick="uploadFile()">Upload</button>
                </div>
            </div>
                                    
            <div class="form-group">
                <button onclick="sendToPython()">Security Assessment</button>
            </div>
            
            <div class="form-group">
                <label>Python Result:</label>
                <textarea id="pythonResult" rows="10" cols="100" readonly></textarea>
            </div>
            <div class="form-group">
                <button onclick="openAnalysisResults()">Analysis Results</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let uploadedFileName = ''; // Store uploaded file path
        let globalImplementationIDArray = []; // Store Implementation IDs
       
/* V1.0 Using the right panel to select the attack ID
            // right panel search function
            function querySolutionRight() {
                const Attack_ID = document.getElementById('Attack_ID').value;// 获取攻击ID的值
                // 获取攻击ID的值
                if (!Attack_ID) {
                    alert('Please select the field');// 获取攻击ID的值
                    return;
                }
                document.getElementById('result-right').innerHTML = 'Sending request...';// 设置发送请求时的提示文本
                // 发送POST请求到后端API
                fetch('/api/query-solution-right', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Attack_ID
                    })
                })
                .then(response => response.json())
                .then(data => {// 显示格式化的JSON结果
                    // 将整个数据数组存储到全局变量
                    globalImplementationIDArray = data;

                    // 仅提取 Implementation_ID 并生成字符串
                    const implementations = data.map(item => item.Implementation_ID).join('<br>');
                    document.getElementById('result-right').innerHTML = 
                        `${implementations}`;
                })
                .catch(error => {// 显示错误信息
                    document.getElementById('result-right').innerHTML = 
                        `Error: ${error.message}`;
                });
            }
*/
   
/* V2.0 Without selections, directly select the implementation ID after Input1 */
           // right panel search function
           function querySolutionRight() {
                // 从 localStorage 获取 globalImplementations_1 数据
                const storedData = localStorage.getItem('globalImplementations_1');
                let Attack_ID;
                
                try {
                    const parsedData = JSON.parse(storedData);
                    // 从数组中获取第一个对象的ID属性
                    Attack_ID = parsedData[0]?.ID;
                } catch (error) {
                    console.error('Error parsing stored data:', error);
                }
                
                if (!Attack_ID) {
                    alert('No Attack ID found. Please select an attack from Input 1 first.');
                    return;
                }
                
                document.getElementById('result-right').innerHTML = 'Sending request...';
                
                fetch('/api/query-solution-right', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Attack_ID
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Received data:', data);
                    
                    if (data && data.data) {
                        globalImplementationIDArray = Array.isArray(data.data) ? data.data : [data.data];
                    } else if (Array.isArray(data)) {
                        globalImplementationIDArray = data;
                    } else if (typeof data === 'object') {
                        globalImplementationIDArray = [data];
                    } else {
                        throw new Error('Unexpected data format');
                    }

                    if (globalImplementationIDArray.length === 0) {
                        document.getElementById('result-right').innerHTML = 'No implementations found';
                        return;
                    }

                    const implementations = globalImplementationIDArray
                        .map(item => {
                            if (typeof item === 'string') {
                                return item;
                            } else if (item && item.Implementation_ID) {
                                return item.Implementation_ID;
                            } else {
                                console.warn('Invalid item format:', item);
                                return 'Invalid implementation data';
                            }
                        })
                        .filter(id => id)
                        .join('<br>');

                    document.getElementById('result-right').innerHTML = implementations || 'No valid implementations found';
                })
                .catch(error => {
                    console.error('Error details:', error);
                    document.getElementById('result-right').innerHTML = 
                        `Error: ${error.message}. Please check the console for details.`;
                });
            }

            // 文件上传函数
            function uploadFile() {
                const fileInput = document.getElementById('fileInput');// 获取文件输入元素
                const file = fileInput.files[0];// 获取选择的第一个文件
                if (!file) {
                    alert('Please select a file first');// 如果未选择文件则提示
                    return;
                }
                //检查文件名后缀是否为.h5
                const fileExtension = file.name.split('.').pop().toLowerCase();
                if (fileExtension !== 'h5') {
                    alert('Only .h5 file format is allowed');
                    return;
    }
                
                const formData = new FormData();// 创建FormData对象用于文件上传
                formData.append('file', file);// 将文件添加到表单数据中
                 // 发送文件上传请求
                fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    uploadedFileName = file.name.replace(/\.h5$/, '');// 保存返回的文件路径
                    alert('File uploaded successfully');// 提示上传成功
                })
                .catch(error => {
                    console.error('Error:', error);// 在控制台记录错误
                    alert('Error uploading file');// 提示上传失败
                });
            }

            // 调用python程序
            async function sendToPython() {
                // 检查是否已上传文件
                if (!uploadedFileName) {
                    alert('Please upload a file first');
                    return;
                }

                // 获取选中的实现ID
                const selectedImplementations = getSelectedImplementations();
                
                // 在控制台显示选中的ID
                console.log('Selected Implementation IDs:', selectedImplementations);
                
                // 检查是否有选中的实现ID
                if (!selectedImplementations || selectedImplementations.length === 0) {
                    alert('Please select at least one implementation');
                    return;
                }

                const pythonResult = document.getElementById('pythonResult');
                pythonResult.value = "Starting to process selected implementations...\n";

                // 依次处理每个选中的Implementation ID
                for (let i = 0; i < selectedImplementations.length; i++) {
                    const implementation_ID = selectedImplementations[i];
                    
                    // 在控制台显示当前正在处理的ID
                    console.log('Processing Implementation ID:', implementation_ID);
                    
                    try {
                        // 更新处理状态
                        pythonResult.value += `\nProcessing Implementation ${implementation_ID}...\n`;

                        // 在发送请求前显示请求内容
                        console.log('Sending request with data:', {
                            implementation_ID,
                            upload_file_name: uploadedFileName
                        });

                        // 发送请求到Python后端
                        const response = await fetch('/api/process', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                implementation_ID,
                                upload_file_name: uploadedFileName
                            })
                        });

                        const data = await response.json();
                        
                        // 显示响应数据
                        console.log('Received response for', implementation_ID, ':', data);
                        
                        // 添加处理结果到显示区域
                        pythonResult.value += `Result for ${implementation_ID}: ${JSON.stringify(data)}\n`;

                    } catch (error) {
                        // 记录错误但继续处理下一个
                        console.error('Error processing:', implementation_ID, error);
                        pythonResult.value += `Error processing ${implementation_ID}: ${error.message}\n`;
                    }

                    // 可选：添加一个小延迟，确保系统有时间处理
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                pythonResult.value += "\nAll selected implementations have been processed.";
                console.log('All processing completed');
            }

            // 直接打开执行结果的文件夹
            function openAnalysisResults() {
                fetch('/api/open-results-folder', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if(data.success) {
                        window.location.href = 'file:///D:/Lee/robust-ai/Attack_Results';                             
                        //alert('Results folder opened successfully');
                    } else {
                        console.error('Failed to open results folder:', data.message);//alert('Failed to open results folder');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error opening results folder');
                });
            }

            // 页面加载时显示结果和生成复选框
            window.onload = function() {
                const searchResults = localStorage.getItem('searchResults');
                if (searchResults) {
                    try {
                        const data = JSON.parse(searchResults);
                        
                        if (data && data.data) {
                            globalImplementationIDArray = Array.isArray(data.data) ? data.data : [data.data];
                        } else if (Array.isArray(data)) {
                            globalImplementationIDArray = data;
                        } else if (typeof data === 'object') {
                            globalImplementationIDArray = [data];
                        }

                        if (globalImplementationIDArray.length === 0) {
                            document.getElementById('result-right').innerHTML = 'No implementations found';
                            return;
                        }

                        // 显示实现ID列表
                        const implementations = globalImplementationIDArray
                            .map(item => {
                                if (typeof item === 'string') {
                                    return item;
                                } else if (item && item.Implementation_ID) {
                                    return item.Implementation_ID;
                                } else {
                                    console.warn('Invalid item format:', item);
                                    return 'Invalid implementation data';
                                }
                            })
                            .filter(id => id)
                            .join('<br>');

                        document.getElementById('result-right').innerHTML = implementations || 'No valid implementations found';

                        // 生成复选框
                        const checkboxContainer = document.getElementById('implementation-checkboxes');
                        checkboxContainer.innerHTML = ''; // 清空现有内容

                        globalImplementationIDArray.forEach((item, index) => {
                            const implementation_id = typeof item === 'string' ? item : item.Implementation_ID;
                            if (!implementation_id) return;

                            const checkboxDiv = document.createElement('div');
                            checkboxDiv.className = 'checkbox-item';

                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.id = `impl-${index}`;
                            checkbox.value = implementation_id;

                            const label = document.createElement('label');
                            label.htmlFor = `impl-${index}`;
                            label.textContent = implementation_id;

                            checkboxDiv.appendChild(checkbox);
                            checkboxDiv.appendChild(label);
                            checkboxContainer.appendChild(checkboxDiv);
                        });

                    } catch (error) {
                        console.error('Error parsing search results:', error);
                        document.getElementById('result-right').innerHTML = 'Error displaying results';
                    }
                }
            };

            // 获取选中的实现ID
            function getSelectedImplementations() {
                const checkboxes = document.querySelectorAll('#implementation-checkboxes input[type="checkbox"]:checked');
                return Array.from(checkboxes).map(checkbox => checkbox.value);
            }

    </script>

    <!-- Foot Section -->
    <footer>
        <p>&copy; 2024 Robust ML Test Bed. All rights reserved.</p>
        <p><a href="#privacy">Privacy Policy</a> | <a href="#terms">Terms of Service</a></p>
    </footer>
</body>
</html> 